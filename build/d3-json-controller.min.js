!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-selection")):"function"==typeof define&&define.amd?define(["exports","d3-selection"],e):e((t=t||self).d3=t.d3||{},t.d3)}(this,function(t,u){"use strict";function l(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function a(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}function E(t){return(E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function i(t){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function o(t,e){return(o=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function s(t,e,r){return(s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}()?Reflect.construct:function(t,e,r){var n=[null];n.push.apply(n,e);var a=new(Function.bind.apply(t,n));return r&&o(a,r.prototype),a}).apply(null,arguments)}function e(t){var n="function"==typeof Map?new Map:void 0;return(e=function(t){if(null===t||(e=t,-1===Function.toString.call(e).indexOf("[native code]")))return t;var e;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==n){if(n.has(t))return n.get(t);n.set(t,r)}function r(){return s(t,arguments,i(this).constructor)}return r.prototype=Object.create(t.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),o(r,t)})(t)}function c(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}var h=eval,r="undefined"!=typeof module&&Boolean(module.exports)&&!("undefined"!=typeof navigator&&"ReactNative"===navigator.product),p=["value","path","pointer","parent","parentProperty","all"],T=Object.prototype.hasOwnProperty,f=r?require("vm"):{runInNewContext:function(t,n){var e=Object.keys(n),r=[];!function(t,e,r){for(var n=t.length,a=0;a<n;a++)r(t[a])&&e.push(t.splice(a--,1)[0])}(e,r,function(t){return"function"==typeof n[t]});var a=r.reduce(function(t,e){var r=n[e].toString();return/function/.exec(r)||(r="function "+r),"var "+e+"="+r+";"+t},"")+e.reduce(function(t,e){return"var "+e+"="+JSON.stringify(n[e]).replace(/\u2028|\u2029/g,function(t){return"\\u202"+("\u2028"===t?"8":"9")})+";"+t},t);return h(a)}};function C(t,e){return(t=t.slice()).push(e),t}function $(t,e){return(e=e.slice()).unshift(t),e}var v=function(t){function r(t){var e;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,r),(e=c(this,i(r).call(this,'JSONPath should not be called with "new" (it prevents return of (unwrapped) scalar values)'))).avoidNew=!0,e.value=t,e.name="NewError",e}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&o(t,e)}(r,e(Error)),r}();function y(t,e,r,n,a){if(!(this instanceof y))try{return new y(t,e,r,n,a)}catch(t){if(!t.avoidNew)throw t;return t.value}"string"==typeof t&&(a=n,n=r,r=e,e=t,t={}),t=t||{};var i=T.call(t,"json")&&T.call(t,"path");if(this.json=t.json||r,this.path=t.path||e,this.resultType=t.resultType&&t.resultType.toLowerCase()||"value",this.flatten=t.flatten||!1,this.wrap=!T.call(t,"wrap")||t.wrap,this.sandbox=t.sandbox||{},this.preventEval=t.preventEval||!1,this.parent=t.parent||null,this.parentProperty=t.parentProperty||null,this.callback=t.callback||n||null,this.otherTypeCallback=t.otherTypeCallback||a||function(){throw new Error("You must supply an otherTypeCallback callback option with the @other() operator.")},!1!==t.autostart){var o=this.evaluate({path:i?t.path:e,json:i?t.json:r});if(!o||"object"!==E(o))throw new v(o);return o}}y.prototype.evaluate=function(t,e,r,n){var a=this,i=this.parent,o=this.parentProperty,u=this.flatten,l=this.wrap;if(this.currResultType=this.resultType,this.currPreventEval=this.preventEval,this.currSandbox=this.sandbox,r=r||this.callback,this.currOtherTypeCallback=n||this.otherTypeCallback,e=e||this.json,(t=t||this.path)&&"object"===E(t)){if(!t.path)throw new Error('You must supply a "path" property when providing an object argument to JSONPath.evaluate().');e=T.call(t,"json")?t.json:e,u=T.call(t,"flatten")?t.flatten:u,this.currResultType=T.call(t,"resultType")?t.resultType:this.currResultType,this.currSandbox=T.call(t,"sandbox")?t.sandbox:this.currSandbox,l=T.call(t,"wrap")?t.wrap:l,this.currPreventEval=T.call(t,"preventEval")?t.preventEval:this.currPreventEval,r=T.call(t,"callback")?t.callback:r,this.currOtherTypeCallback=T.call(t,"otherTypeCallback")?t.otherTypeCallback:this.currOtherTypeCallback,i=T.call(t,"parent")?t.parent:i,o=T.call(t,"parentProperty")?t.parentProperty:o,t=t.path}if(i=i||null,o=o||null,Array.isArray(t)&&(t=y.toPathString(t)),t&&e&&p.includes(this.currResultType)){this._obj=e;var s=y.toPathArray(t);"$"===s[0]&&1<s.length&&s.shift(),this._hasParentSelector=null;var c=this._trace(s,e,["$"],i,o,r).filter(function(t){return t&&!t.isParentSelector});return c.length?1!==c.length||l||Array.isArray(c[0].value)?c.reduce(function(t,e){var r=a._getPreferredOutput(e);return u&&Array.isArray(r)?t=t.concat(r):t.push(r),t},[]):this._getPreferredOutput(c[0]):l?[]:void 0}},y.prototype._getPreferredOutput=function(t){var e=this.currResultType;switch(e){default:throw new TypeError("Unknown result type");case"all":return t.pointer=y.toPointer(t.path),t.path="string"==typeof t.path?t.path:y.toPathString(t.path),t;case"value":case"parent":case"parentProperty":return t[e];case"path":return y.toPathString(t[e]);case"pointer":return y.toPointer(t.path)}},y.prototype._handleCallback=function(t,e,r){if(e){var n=this._getPreferredOutput(t);t.path="string"==typeof t.path?t.path:y.toPathString(t.path),e(n,r,t)}},y.prototype._trace=function(t,e,r,n,a,i,o){var u,l=this;if(!t.length)return u={path:r,value:e,parent:n,parentProperty:a},this._handleCallback(u,i,"value"),u;var s=t[0],c=t.slice(1),h=[];function p(t){Array.isArray(t)?t.forEach(function(t){h.push(t)}):h.push(t)}if(("string"!=typeof s||o)&&e&&T.call(e,s))p(this._trace(c,e[s],C(r,s),e,s,i));else if("*"===s)this._walk(s,c,e,r,n,a,i,function(t,e,r,n,a,i,o,u){p(l._trace($(t,r),n,a,i,o,u,!0))});else if(".."===s)p(this._trace(c,e,r,n,a,i)),this._walk(s,c,e,r,n,a,i,function(t,e,r,n,a,i,o,u){"object"===E(n[t])&&p(l._trace($(e,r),n[t],C(a,t),n,t,u))});else{if("^"===s)return this._hasParentSelector=!0,r.length?{path:r.slice(0,-1),expr:c,isParentSelector:!0}:[];if("~"===s)return u={path:C(r,s),value:a,parent:n,parentProperty:null},this._handleCallback(u,i,"property"),u;if("$"===s)p(this._trace(c,e,r,null,null,i));else if(/^(-?\d*):(-?\d*):?(\d*)$/.test(s))p(this._slice(s,c,e,r,n,a,i));else if(0===s.indexOf("?(")){if(this.currPreventEval)throw new Error("Eval [?(expr)] prevented in JSONPath expression.");this._walk(s,c,e,r,n,a,i,function(t,e,r,n,a,i,o,u){l._eval(e.replace(/^\?\((.*?)\)$/,"$1"),n[t],t,a,i,o)&&p(l._trace($(t,r),n,a,i,o,u))})}else if("("===s[0]){if(this.currPreventEval)throw new Error("Eval [(expr)] prevented in JSONPath expression.");p(this._trace($(this._eval(s,e,r[r.length-1],r.slice(0,-1),n,a),c),e,r,n,a,i))}else if("@"===s[0]){var f=!1,v=s.slice(1,-2);switch(v){default:throw new TypeError("Unknown value type "+v);case"scalar":e&&["object","function"].includes(E(e))||(f=!0);break;case"boolean":case"string":case"undefined":case"function":E(e)===v&&(f=!0);break;case"number":E(e)===v&&isFinite(e)&&(f=!0);break;case"nonFinite":"number"!=typeof e||isFinite(e)||(f=!0);break;case"object":e&&E(e)===v&&(f=!0);break;case"array":Array.isArray(e)&&(f=!0);break;case"other":f=this.currOtherTypeCallback(e,r,n,a);break;case"integer":e!==Number(e)||!isFinite(e)||e%1||(f=!0);break;case"null":null===e&&(f=!0)}if(f)return u={path:r,value:e,parent:n,parentProperty:a},this._handleCallback(u,i,"value"),u}else if("`"===s[0]&&e&&T.call(e,s.slice(1))){var y=s.slice(1);p(this._trace(c,e[y],C(r,y),e,y,i,!0))}else if(s.includes(",")){var _=s.split(","),d=!0,g=!1,b=void 0;try{for(var k,m=_[Symbol.iterator]();!(d=(k=m.next()).done);d=!0){var w=k.value;p(this._trace($(w,c),e,r,n,a,i))}}catch(t){g=!0,b=t}finally{try{d||null==m.return||m.return()}finally{if(g)throw b}}}else!o&&e&&T.call(e,s)&&p(this._trace(c,e[s],C(r,s),e,s,i,!0))}if(this._hasParentSelector)for(var P=0;P<h.length;P++){var x=h[P];if(x.isParentSelector){var S=l._trace(x.expr,e,x.path,n,a,i);if(Array.isArray(S)){h[P]=S[0];for(var j=S.length,O=1;O<j;O++)P++,h.splice(P,0,S[O])}else h[P]=S}}return h},y.prototype._walk=function(t,e,r,n,a,i,o,u){if(Array.isArray(r))for(var l=r.length,s=0;s<l;s++)u(s,t,e,r,n,a,i,o);else if("object"===E(r))for(var c in r)T.call(r,c)&&u(c,t,e,r,n,a,i,o)},y.prototype._slice=function(t,e,r,n,a,i,o){if(Array.isArray(r)){var u=r.length,l=t.split(":"),s=l[2]&&parseInt(l[2])||1,c=l[0]&&parseInt(l[0])||0,h=l[1]&&parseInt(l[1])||u;c=c<0?Math.max(0,c+u):Math.min(u,c),h=h<0?Math.max(0,h+u):Math.min(u,h);for(var p=[],f=c;f<h;f+=s){var v=this._trace($(f,e),r,n,a,i,o);Array.isArray(v)?v.forEach(function(t){p.push(t)}):p.push(v)}return p}},y.prototype._eval=function(e,t,r,n,a,i){if(!this._obj||!t)return!1;e.includes("@parentProperty")&&(this.currSandbox._$_parentProperty=i,e=e.replace(/@parentProperty/g,"_$_parentProperty")),e.includes("@parent")&&(this.currSandbox._$_parent=a,e=e.replace(/@parent/g,"_$_parent")),e.includes("@property")&&(this.currSandbox._$_property=r,e=e.replace(/@property/g,"_$_property")),e.includes("@path")&&(this.currSandbox._$_path=y.toPathString(n.concat([r])),e=e.replace(/@path/g,"_$_path")),e.match(/@([.\s)[])/)&&(this.currSandbox._$_v=t,e=e.replace(/@([.\s)[])/g,"_$_v$1"));try{return f.runInNewContext(e,this.currSandbox)}catch(t){throw console.log(t),new Error("jsonPath: "+t.message+": "+e)}},y.cache={},y.toPathString=function(t){for(var e=t,r=e.length,n="$",a=1;a<r;a++)/^(~|\^|@.*?\(\))$/.test(e[a])||(n+=/^[0-9*]+$/.test(e[a])?"["+e[a]+"]":"['"+e[a]+"']");return n},y.toPointer=function(t){for(var e=t,r=e.length,n="",a=1;a<r;a++)/^(~|\^|@.*?\(\))$/.test(e[a])||(n+="/"+e[a].toString().replace(/~/g,"~0").replace(/\//g,"~1"));return n},y.toPathArray=function(t){var e=y.cache;if(e[t])return e[t].concat();var r=[],n=t.replace(/@(?:null|boolean|number|string|integer|undefined|nonFinite|scalar|array|object|function|other)\(\)/g,";$&;").replace(/[['](\??\(.*?\))[\]']/g,function(t,e){return"[#"+(r.push(e)-1)+"]"}).replace(/\['([^'\]]*)'\]/g,function(t,e){return"['"+e.replace(/\./g,"%@%").replace(/~/g,"%%@@%%")+"']"}).replace(/~/g,";~;").replace(/'?\.'?(?![^[]*\])|\['?/g,";").replace(/%@%/g,".").replace(/%%@@%%/g,"~").replace(/(?:;)?(\^+)(?:;)?/g,function(t,e){return";"+e.split("").join(";")+";"}).replace(/;;;|;;/g,";..;").replace(/;$|'?\]|'$/g,"").split(";").map(function(t){var e=t.match(/#(\d+)/);return e&&e[1]?r[e[1]]:t});return e[t]=n,e[t]};var _=function(){function e(t){l(this,e),this._element=t}return a(e,[{key:"update",value:function(t,e,r){this._element.html(t)}}]),e}(),d=function(){function n(t,e,r){l(this,n),this._controller=t,this._element=e,this._level=r,this._controller.registerListener(this.update.bind(this),"$.*"),this.draw()}return a(n,[{key:"draw",value:function(){var t;this.playback_container=this._element.append("div").attr("class","json-controller-controls"),this.prevButton=this.playback_container.append("button").on("mousedown",(t=this,function(){t._controller.previous(t._level)})),this.prevButton.append("svg").attr("viewBox","0 0 200 200").attr("width",20).attr("height",20).append("path").attr("fill","#b0b0b0").attr("d","M170.711,170.711a100,100,0,1,1,0-141.422A100,100,0,0,1,170.711,170.711ZM121.945,63.426a6.9,6.9,0,0,0-9.754-9.753L70.74,95.123a6.9,6.9,0,0,0,0,9.754l41.451,41.451a6.9,6.9,0,1,0,9.754-9.754L85.37,100Z");var e,r,n=this.playback_container.append("span").attr("class","jump");this._jump_input=n.append("input").attr("value",0).on("change",(e=this,function(){e._controller.goto(e._level,e._jump_input.node().value)})),this.next_button=this.playback_container.append("button").on("mousedown",(r=this,function(){r._controller.next(r._level)})),this.next_button.append("svg").attr("viewBox","0 0 200 200").attr("width",20).attr("height",20).append("path").attr("fill","#b0b0b0").attr("d","M29.289,29.289a100,100,0,1,1,0,141.422A100,100,0,0,1,29.289,29.289ZM78.055,136.574a6.9,6.9,0,1,0,9.753,9.754l41.451-41.451a6.9,6.9,0,0,0,0-9.754L87.809,53.672a6.9,6.9,0,0,0-9.753,9.753L114.63,100Z")}},{key:"update",value:function(t,e){this._controller.isStart(this._level)?this.prevButton.attr("disabled",""):this.prevButton.attr("disabled",null);var r=this._controller.currentIndex(this._level);this._jump_input.node().value=r,this._controller.isEnd(this._level)?this.next_button.attr("disabled",""):this.next_button.attr("disabled",null)}}]),n}(),g=function(){function o(t,e){l(this,o),this._elements_by_path={};var r=[];t.selectAll(e).each(function(){r.push({node:this,children:[]})});var n,a,i=[];r.forEach((n=this,a=r,function(t,e){var r=function t(e,r){if(null==e.parentNode)return null;var n=!0,a=!1,i=void 0;try{for(var o,u=r[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var l=o.value;if(l.node===e.parentNode)return l}}catch(t){a=!0,i=t}finally{try{n||null==u.return||u.return()}finally{if(a)throw i}}return t(e.parentNode,r)}(t.node,a);r?(t.path=r.path.concat([r.children.length]),r.children.push(t)):(t.path=[i.length],i.push(t)),n._elements_by_path[t.path]=u.select(t.node)}))}return a(o,[{key:"forEach",value:function(t){for(var e=0,r=Object.keys(this._elements_by_path);e<r.length;e++){var n=r[e];t(n=n.split(",").map(function(t){return parseInt(t)}),this._elements_by_path[n])}}},{key:"elementByPath",value:function(t){return this._elements_by_path[t]}}]),o}();function b(t,e){return new g(t,e)}var k=function(){function u(t,e,r){if(l(this,u),this._hierarchicalSelection=b(t,e),this._mapping=r,this._reverseMapping=null,this._mapping){this._reverseMapping={};for(var n=0,a=Object.keys(this._mapping);n<a.length;n++){var i=a[n],o=i.split(",").filter(function(t){return 0<t.length}).map(function(t){return parseInt(t)});this._reverseMapping[this._mapping[i]]=o}}}return a(u,[{key:"update",value:function(t,e,r){var n=r;this._mapping&&(n=this._mapping[String(r)]),this._hierarchicalSelection.forEach(function(r,t){t.classed("d3-json-controller-selected",function(t,e){return r&&n&&r.toString()===n.toString()})})}},{key:"reverseMapping",value:function(){return this._reverseMapping}}]),u}(),m=function(){function e(t){l(this,e),this._element=t,this._element.classed("d3-json-controller-hint",!0)}return a(e,[{key:"update",value:function(t,e,r){r?this._element.style("display","none"):this._element.style("display",null)}}]),e}(),w=function(){function r(t,e){l(this,r),this._data=t,this._config=e,void 0===this._config&&(this._config={}),this.transitionDuration=400,this._listeners=[],this._listener_paths=[],this._current_path=[],this._current_length=[],this.updateLengths()}return a(r,[{key:"registerListener",value:function(t,e){this._listeners.push(t),this._listener_paths.push(e)}},{key:"updateListeners",value:function(t){void 0===t&&(t=this.transitionDuration);for(var e=0;e<this._listeners.length;e++)this._listeners[e](this.getPath(this._listener_paths[e]),t,this.getCurrentMatchingPath(this._listener_paths[e]))}},{key:"updateLengths",value:function(){for(var t=this._data,e=0;e<this._current_path.length;e++)this._current_length[e]=t.length,t=-1===this._current_path[e]?[]:t[this._current_path[e]]}},{key:"validateIndex",value:function(t){for(var e=this._data,r=0;r<t.length;r++){if(!(e instanceof Object))return!1;if("string"==typeof t[r]&&"undefined"===e[t[r]])return!1;if("number"==typeof t[r]&&(t[r]<0||t[r]>=e.length))return!1;e=e[t[r]]}return!0}},{key:"moveIndexInBounds",value:function(t){console.log("moveIndexInBounds: "+t);for(var e=t.slice(0),r=this._data,n=0;n<t.length;n++)"number"==typeof t[n]&&(!e[n]||e[n]<0?e[n]=0:e[n]>=r.length&&(e[n]=r.length-1)),r=r[e[n]];return e}},{key:"goto",value:function(t,e){var r=this._current_path.slice();r[t]=e,this.validateIndex(r)?(this._current_path=r,this.updateLengths(),this.updateListeners()):(r=this.moveIndexInBounds(r),this.validateIndex(r)?(this._current_path=r,this.updateLengths(),this.updateListeners()):console.log("Cannot set goto index"+e+" at level "+t+"in data with "+this._current_path.length+" levels"))}},{key:"gotoLevel",value:function(t){var e=this._current_path.slice(0,Math.max(0,t+1));this.validateIndex(e)&&(this._current_path=e,this.updateLengths(),this.updateListeners())}},{key:"gotoPath",value:function(t){this.validateIndex(t)?(this._current_path=t,this.updateLengths(),this.updateListeners()):(console.log(t),console.error("Invalid path: "+t))}},{key:"data",value:function(t){var e=this.get(this._current_path);return t?e[t]:e}},{key:"get",value:function(t){var e=this._data;if(this.validateIndex(t))for(var r=0;r<t.length&&-1!==t[r];r++)e=e[t[r]];return e}},{key:"matchCurrentPath",value:function(t){if("$"===t)return[[],[]];if(0===this._current_path.length)return[null,null];for(var e=y({resultType:"path",path:t,json:this._data}),r=0;r<e.length;r++){for(var n=y.toPathArray(e[r]).map(function(t){var e=parseInt(t);return Object.is(NaN,e)?t:e}),a=!0,i=0;i<this._current_path.length;i++)if(n[i+1]!==this._current_path[i]){a=!1;break}if(a)return[n.slice(1),this._current_path.slice(n.length-1)]}return[null,null]}},{key:"getCurrentMatchingPath",value:function(t){return this.matchCurrentPath(t)[0]}},{key:"getCurrentTrailingPath",value:function(t){return this.matchCurrentPath(t)[1]}},{key:"getPath",value:function(t){var e=this.getCurrentMatchingPath(t);if(e)return this.get(e)}},{key:"currentPath",value:function(){return this._current_path}},{key:"currentIndex",value:function(t){return this._current_path[t]}},{key:"maxIndex",value:function(t){return this._current_length[t]-1}},{key:"isStart",value:function(t){return 0===this._current_path[t]}},{key:"isEnd",value:function(t){return this._current_path[t]===this.maxIndex(t)}},{key:"start",value:function(t){this.goto(t,0)}},{key:"previous",value:function(t){this.goto(t,this._current_path[t]-1)}},{key:"next",value:function(t){this.goto(t,this._current_path[t]+1)}},{key:"end",value:function(t){this.goto(t,this.maxIndex(t))}},{key:"registerHover",value:function(t,e){var r,n;t.on("mouseenter",(r=this,function(){return r.gotoPath(e),!1})),t.on("mouseleave",(n=this,function(){return n.gotoLevel(e.length-2),!1}))}},{key:"registerHoverHierarchy",value:function(t,e,n){var a;b(t,e).forEach((a=this,function(t,e){var r=t;n&&(r=n[String(t)]),a.registerHover(e,r)}))}},{key:"controls",value:function(t,e){return new d(this,t,e)}},{key:"caption",value:function(t){return new _(t)}},{key:"highlight",value:function(t,e,r){return new k(t,e,r)}},{key:"hint",value:function(t){var e=new m(t);return this.registerListener(e.update.bind(e),"$..*"),e}}]),r}();t.JSONController=function(t){return new w(t)},Object.defineProperty(t,"__esModule",{value:!0})});